<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>json to dart</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      html,
      body {
        width: 100%;
        height: 100%;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      .wrap {
        flex: 1;
        display: flex;
      }
      textarea {
        flex: 1;
        padding: 5px;
        resize: none;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <textarea id="input" oninput="handleInput()"></textarea>
      <textarea id="result"></textarea>
    </div>
    <div class="config">
      <input type="text" placeholder="class name" id="class_name" oninput="handleInput()" />
      <label>
        <input type="checkbox" id="config_required" onchange="handleConfigChange(this)" />
        add required
      </label>
      <label>
        <input type="checkbox" id="config_final" onchange="handleConfigChange(this)" />
        add final
      </label>
    </div>
  </body>
  <script>
    const typesMap = {
      string: 'String',
      number: 'int',
      boolean: 'bool',
      object: 'Map',
      array: 'List'
    };
    const config = {
      required: true,
      final: false,
      ...JSON.parse(localStorage.getItem('config') || '{}')
    };

    for (let key in config) {
      document.getElementById(`config_${key}`).checked = config[key];
    }

    function jsonToDart(json, name, config) {
      let res = [`class ${name} {`];

      const part1 = [];
      const part2 = [];
      const part3 = [];
      const part4 = [];
      const dep = [];

      for (const key in json) {
        const value = json[key];
        let type = typesMap[typeof value];

        part1.push(`    ${config.required ? 'required ' : ''}this.${key},`);

        if (Array.isArray(value)) {
          const t = name + key[0].toUpperCase() + key.replace(/(.+)s$/, '$1').slice(1);
          const type = `${typesMap.array}<${t}>`;
          const v = value.reduce((a, b) => ({ ...a, ...b }), {});
          dep.push(jsonToDart(v, t, config));
          part2.push(`  late${config.final ? ' final' : ''} ${type}${config.required ? '' : '?'} ${key};`);
          part3.push(`    ${key} = List${config.required ? '' : '?'}.from(json['${key}']).map((e) => ${t}.fromJson(e)).toList();`);
          part4.push(`    _data['${key}'] = ${key}${config.required ? '' : '?'}.map((e) => e.toJson()).toList();`);
        } else if (typeof value === 'object') {
          const type = name + key[0].toUpperCase() + key.slice(1);
          const v = jsonToDart(value, type, config);
          dep.push(v);
          part2.push(`  late${config.final ? ' final' : ''} ${type}${config.required ? '' : '?'} ${key};`);

          part3.push(`    ${key} = ${type}.fromJson(json['${key}']);`);
          part4.push(`    _data['${key}'] = ${key}.toJson();`);
        } else {
          part2.push(`  late${config.final ? ' final' : ''} ${type}${config.required ? '' : '?'} ${key};`);
          part3.push(`    ${key} = json['${key}'];`);
          part4.push(`    _data['${key}'] = ${key};`);
        }
      }
      // part1
      res.push(`  ${name}({`);
      res.push(...part1);
      res.push(`  });`);
      // part2
      res.push(...part2);
      // part3
      res.push(`\n  ${name}.fromJson(Map<String, dynamic> json) {`);
      res.push(...part3);
      res.push(`  }`);

      // part4
      res.push(`\n  Map<String, dynamic> toJson() {`);
      res.push(`    final _data = <String, dynamic>{};`);
      res.push(...part4);
      res.push(`    return _data;`);
      res.push(`  }`);

      // end
      res.push('\n  @override');
      res.push('  String toString() {');
      res.push('    return toJson().toString();');
      res.push('  }');
      res.push('}\n');

      // dep
      res.push(...dep);
      return res.join('\n');
    }
    function handleInput() {
      const json = JSON.parse(input.value);
      result.value = jsonToDart(json, class_name.value || 'Root', config);
    }

    function handleConfigChange(it) {
      config[it.id.split('_')[1]] = it.checked;
      localStorage.setItem('config', JSON.stringify(config));
      handleInput();
    }

    window.onload = () => {
      input.value = JSON.stringify(
        {
          string: 'ssss',
          number: 123,
          boolean: false,

          map: {
            number: 123
          },

          list: [{ string: 'asdsd' }, { number: 123 }]
        },
        void 0,
        2
      );
      handleInput();
    };
  </script>
</html>
